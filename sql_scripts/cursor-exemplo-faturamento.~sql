DECLARE
   --CURSOR DECLARATION
  CURSOR C_CANCELAAF ( P_NUM_AUTORIZACAO_ENTREGA AUTORIZACAO_ENTREGA.NUM_AUTORIZACAO_ENTREGA%TYPE
                      ,P_ANO_AUTORIZACAO_ENTREGA AUTORIZACAO_ENTREGA.ANO_AUTORIZACAO_ENTREGA%TYPE
                      ,P_COD_INSTITUICAO AUTORIZACAO_ENTREGA.COD_INSTITUICAO%TYPE ) IS
     ------- SELECT 
      SELECT    OS.NUM_ORDEM_SERVICO||'/'||OS.ANO_ORDEM_SERVICO OS,
                OS.DSC_SERVICO,
                PS.NUM_PEDIDO_SERVICO,
                PS.NUM_AGRUPAMENTO,
                AES.NUM_AUT_ENTREGA_SERVICO,
                AES.COD_INSTITUICAO,                          
                AES.NUM_AUTORIZACAO_ENTREGA,
                AES.ANO_AUTORIZACAO_ENTREGA, 
                AES.VLR_CONTRATACAO,
                AES.VLR_CONTRATACAO_MOBRA,
                AES.VLR_CONTRATACAO_MATERIAL,
                AES.DTA_HOR_CANCELAMENTO,
                AAES.NUM_DOC_FINANCEIRO,        
                AAES.IDF_RECEBIDO,
                AAES.IDF_STATUS_AGENDA,
                D.NUM_ORCAMENTO||'/'||D.ANO_ORCAMENTO DISPENSA,
                AC.IDF_TIPO_AGRUPAMENTO,
                AC.VLR_ORCAMENTO,                   
                DF.NUM_DOCUMENTO NF_S,
                DF.STA_DOCUMENTO
      FROM ORDEM_SERVICO OS
      JOIN TRIAGEM_ORDEM_SERVICO TOS  ON TOS.NUM_ORDEM = OS.NUM_ORDEM
      JOIN PEDIDO_SERVICO PS ON PS.NUM_TRIAGEM_OS = TOS.NUM_TRIAGEM_OS
      JOIN DISPENSA D ON D.NUM_AGRUPAMENTO = PS.NUM_AGRUPAMENTO
      JOIN AGRUPAMENTO_COMPRA AC ON AC.NUM_AGRUPAMENTO = PS.NUM_AGRUPAMENTO
      JOIN COTACAO_PEDIDO_SERVICO CPS ON CPS.NUM_PEDIDO_SERVICO = PS.NUM_PEDIDO_SERVICO
      JOIN AUTORIZACAO_ENTREGA_SERVICO AES ON AES.NUM_COTACAO_SERVICO = CPS.NUM_COTACAO_SERVICO
      LEFT JOIN AGENDA_AUT_ENTREGA_SERVICO AAES ON AAES.NUM_AUT_ENTREGA_SERVICO = AES.NUM_AUT_ENTREGA_SERVICO
      LEFT JOIN DOCUMENTO_FINANCEIRO DF ON DF.NUM_DOC_FINANCEIRO = AAES.NUM_DOC_FINANCEIRO                   
      WHERE 1 = 1
      AND AES.NUM_AUTORIZACAO_ENTREGA = P_NUM_AUTORIZACAO_ENTREGA
      AND AES.ANO_AUTORIZACAO_ENTREGA = P_ANO_AUTORIZACAO_ENTREGA
      AND AES.COD_INSTITUICAO = P_COD_INSTITUICAO;                  
     
     R_CANCELAAF C_CANCELAAF%ROWTYPE;       
BEGIN 
  ---------------------------------
   --OPEN CURSOR 
   OPEN C_CANCELAAF(20787, 2021, 2);
   
   LOOP     
      --FEED REGISTER WITH CURSOR
      FETCH C_CANCELAAF INTO R_CANCELAAF;
      EXIT WHEN C_CANCELAAF%NOTFOUND;
      
      DBMS_OUTPUT.put_line('AS: '||R_CANCELAAF.NUM_AUT_ENTREGA_SERVICO||' OS: '||R_CANCELAAF.OS||' '||R_CANCELAAF.DSC_SERVICO);
      --DBMS_OUTPUT.put_line(R_CANCELAAF.NUM_AUT_ENTREGA_SERVICO);
   END LOOP;   
   --CLOSE CURSOR
   CLOSE C_CANCELAAF;
   ---------------------------------
END;
