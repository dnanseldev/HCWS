 --  AND TOS.SEQ_GRUPO_ESTATISTICA = '06/01/2021 00:00:00'2

-------------------------------------------------------------------------
-- Custo dos materiais Gastos, com base no custo médio
SELECT DISTINCT OS.NUM_ORDEM,
                OS.NUM_ORDEM_SERVICO || '/' || OS.ANO_ORDEM_SERVICO NUM_OS,
                OS.COD_CENCUSTO,
                TOS.COD_UNIDADE_EXECUTANTE,
                IRM.DTA_MOV_CONTABIL DTA_OCORRENCIA,
                UE.NOM_UNIDADE_EXECUTANTE,
                0 QTD_OS_CONCLUIDA,
                0 QTD_HOR_APONT,
                0 VLR_SERVICO_EXTERNO,

                SUM(IRM.VLR_PONDERADO * IRM.QTD_FORNE_RECEBIDA *
                    DECODE(RM.IDF_TIPO_REQUISICAO, 0, 1, 1, -1, 0)) VLR_MATERIAL,

                0 VLR_FATURADO,
                GC.COD_GRUPO,
                GC.DSC_GRUPO,
                GC.ORD_IMPRESSAO
  FROM ITEM_REQUISICAO_MATERIAL IRM,
       REQUISICAO_MATERIAL RM,
       COMPLEMENTO_REQUISICAO CR,
       TRIAGEM_ORDEM_SERVICO TOS,
       ORDEM_SERVICO OS,
       CENTRO_CUSTO CC,
       GRUPO_CENCUSTO GC,
       (SELECT COD_UNIDADE_EXECUTANTE, NOM_UNIDADE_EXECUTANTE
          FROM UNIDADE_EXECUTANTE
         START WITH COD_UNIDADE_EXECUTANTE IN (2,5,6,7,8,9,11,22,70)
        CONNECT BY PRIOR COD_UNIDADE_EXECUTANTE = COD_UNIDADE_EXECUTANTE_PAI) UE

 WHERE IRM.DTA_MOV_CONTABIL BETWEEN TO_DATE('06/01/2015', 'DD/MM/YYYY') AND    TO_DATE('31/12/2020', 'DD/MM/YYYY')

   AND IRM.NUM_REQUISICAO = RM.NUM_REQUISICAO
   AND IRM.ANO_REQUISICAO_MATERIAL = RM.ANO_REQUISICAO_MATERIAL
   AND RM.ANO_REQUISICAO_MATERIAL = CR.ANO_REQUISICAO_MATERIAL
   AND RM.NUM_REQUISICAO = CR.NUM_REQUISICAO
   AND CR.IDF_TIPO_DOCUMENTO = 17
   AND CR.NUM_DOCUMENTO = TOS.NUM_TRIAGEM_OS
   AND TOS.NUM_ORDEM = OS.NUM_ORDEM
   AND OS.COD_CENCUSTO = CC.COD_CENCUSTO
   AND CC.COD_GRUPO = GC.COD_GRUPO(+)
   AND TOS.COD_UNIDADE_EXECUTANTE = UE.COD_UNIDADE_EXECUTANTE
  -- AND TOS.SEQ_GRUPO_ESTATISTICA = 5

   AND OS.COD_CENCUSTO IN ('CACK00013', 'CACN0001X', 'CACK00049', 'CACL00019','CACN04014')

 GROUP BY OS.NUM_ORDEM,
          OS.NUM_ORDEM_SERVICO,
          OS.ANO_ORDEM_SERVICO,
          OS.COD_CENCUSTO,

          TOS.COD_UNIDADE_EXECUTANTE,
          IRM.DTA_MOV_CONTABIL,
          UE.NOM_UNIDADE_EXECUTANTE,

          GC.COD_GRUPO,
          GC.DSC_GRUPO,
          GC.ORD_IMPRESSAO
