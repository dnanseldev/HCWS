/*Daniel Anselmo 
Cancelar AFs, recebimento, pedido de serviço e voltar dotação*/
DECLARE
   
  CURSOR C_CANCELAAF ( P_NUM_AUTORIZACAO_ENTREGA AUTORIZACAO_ENTREGA.NUM_AUTORIZACAO_ENTREGA%TYPE
                      ,P_ANO_AUTORIZACAO_ENTREGA AUTORIZACAO_ENTREGA.ANO_AUTORIZACAO_ENTREGA%TYPE
                      ,P_COD_INSTITUICAO AUTORIZACAO_ENTREGA.COD_INSTITUICAO%TYPE ) IS
     
      SELECT    OS.NUM_ORDEM_SERVICO||'/'||OS.ANO_ORDEM_SERVICO OS,
                OS.DSC_SERVICO,
                (SELECT UE.NOM_UNIDADE_EXECUTANTE FROM UNIDADE_EXECUTANTE UE
                  WHERE UE.COD_UNIDADE_EXECUTANTE = OS.COD_UNIDADE_EXECUTANTE) NOM_UNIDADE_EXECUTANTE,
                PS.NUM_PEDIDO_SERVICO,
                PS.NUM_AGRUPAMENTO,
                AES.NUM_AUT_ENTREGA_SERVICO,
                AES.COD_INSTITUICAO,                          
                AES.NUM_AUTORIZACAO_ENTREGA,
                AES.ANO_AUTORIZACAO_ENTREGA, 
                AES.VLR_CONTRATACAO,
                AES.VLR_CONTRATACAO_MOBRA,
                AES.VLR_CONTRATACAO_MATERIAL,
                AES.DTA_HOR_CANCELAMENTO,
                AAES.NUM_DOC_FINANCEIRO,        
                AAES.IDF_RECEBIDO,
                AAES.IDF_STATUS_AGENDA,
                D.NUM_ORCAMENTO||'/'||D.ANO_ORCAMENTO DISPENSA,
                AC.IDF_TIPO_AGRUPAMENTO,
                AC.VLR_ORCAMENTO,                   
                DF.NUM_DOCUMENTO NF_S,
                DF.STA_DOCUMENTO
      FROM ORDEM_SERVICO OS
      JOIN TRIAGEM_ORDEM_SERVICO TOS  ON TOS.NUM_ORDEM = OS.NUM_ORDEM
      JOIN PEDIDO_SERVICO PS ON PS.NUM_TRIAGEM_OS = TOS.NUM_TRIAGEM_OS
      JOIN DISPENSA D ON D.NUM_AGRUPAMENTO = PS.NUM_AGRUPAMENTO
      JOIN AGRUPAMENTO_COMPRA AC ON AC.NUM_AGRUPAMENTO = PS.NUM_AGRUPAMENTO
      JOIN COTACAO_PEDIDO_SERVICO CPS ON CPS.NUM_PEDIDO_SERVICO = PS.NUM_PEDIDO_SERVICO
      JOIN AUTORIZACAO_ENTREGA_SERVICO AES ON AES.NUM_COTACAO_SERVICO = CPS.NUM_COTACAO_SERVICO
      LEFT JOIN AGENDA_AUT_ENTREGA_SERVICO AAES ON AAES.NUM_AUT_ENTREGA_SERVICO = AES.NUM_AUT_ENTREGA_SERVICO
      LEFT JOIN DOCUMENTO_FINANCEIRO DF ON DF.NUM_DOC_FINANCEIRO = AAES.NUM_DOC_FINANCEIRO                   
      WHERE 1 = 1
      AND AES.NUM_AUTORIZACAO_ENTREGA = P_NUM_AUTORIZACAO_ENTREGA
      AND AES.ANO_AUTORIZACAO_ENTREGA = P_ANO_AUTORIZACAO_ENTREGA
      AND AES.COD_INSTITUICAO = P_COD_INSTITUICAO;                  
     
     R_CANCELAAF C_CANCELAAF%ROWTYPE;
     
     L_SEQ_DOTACCAO DOTACAO_ESTR_ORC_UTILIZACAO.SEQ_DOTACAO_ESTR_ORC_UTILIZ%TYPE;       
BEGIN 
  ---------------------------------
   
   OPEN C_CANCELAAF(20794, 2021, 2);
   
   LOOP       
      FETCH C_CANCELAAF INTO R_CANCELAAF;
      EXIT WHEN C_CANCELAAF%NOTFOUND;      
      
      UPDATE AUTORIZACAO_ENTREGA_SERVICO AES
      SET AES.DTA_HOR_CANCELAMENTO = SYSDATE
         ,AES.NUM_USER_BANCO_CANCELAMENTO = FC_NUM_USER_BANCO
      WHERE AES.NUM_AUT_ENTREGA_SERVICO = R_CANCELAAF.NUM_AUT_ENTREGA_SERVICO;
      
      DBMS_OUTPUT.PUT_LINE('AS cancelada');
      
      UPDATE AGENDA_AUT_ENTREGA_SERVICO AAES
      SET AAES.IDF_STATUS_AGENDA = 2
         ,AAES.NUM_DOC_FINANCEIRO = NULL
         ,AAES.IDF_RECEBIDO = 'N'
         ,AAES.DSC_OBS_CANCELA_AGENDA = 'CANCELADO A PEDIDO DO COMPRADOR: '||R_CANCELAAF.NOM_UNIDADE_EXECUTANTE
      WHERE AAES.NUM_AUT_ENTREGA_SERVICO = R_CANCELAAF.NUM_AUT_ENTREGA_SERVICO;
      
      DBMS_OUTPUT.PUT_LINE('Agendamento cancelado');
      
      UPDATE PEDIDO_SERVICO PS
      SET PS.IDF_ESTAGIO_PEDIDO = 9
      WHERE PS.NUM_AGRUPAMENTO = R_CANCELAAF.NUM_AGRUPAMENTO;
      
      DBMS_OUTPUT.PUT_LINE('Pedido de serviço cancelado');
      
      UPDATE AGRUPAMENTO_COMPRA AC
      SET AC.IDF_ESTAGIO_AGRUPAMENTO = 8
      WHERE AC.NUM_AGRUPAMENTO = R_CANCELAAF.NUM_AGRUPAMENTO;
      
      DBMS_OUTPUT.PUT_LINE('Agrupamento cancelado');
      
      SELECT DEOU.SEQ_DOTACAO_ESTR_ORC_UTILIZ INTO L_SEQ_DOTACCAO
         FROM ESTOQUE.DOTACAO_ESTR_ORC_UTILIZACAO DEOU
      WHERE DEOU.NUM_AUT_ENTREGA_SERVICO = R_CANCELAAF.NUM_AUT_ENTREGA_SERVICO;
      
      /*RETORNAR DOTAÇÃO*/
      
      IF L_SEQ_DOTACCAO IS NOT NULL THEN
      BEGIN
         ESTOQUE.PROC_VALIDAR_DOTACAO_AF(R_CANCELAAF.NUM_AUTORIZACAO_ENTREGA, R_CANCELAAF.ANO_AUTORIZACAO_ENTREGA, R_CANCELAAF.COD_INSTITUICAO);
         DBMS_OUTPUT.PUT_LINE('Dotação retornada');               
      END;      
      
   END LOOP;
   
   EXCEPTION 
     WHEN OTHERS THEN
     BEGIN
        RAISE_APPLICATION_ERROR(-20001,'An error was encountered - '||SQLCODE||' -ERROR- '||SQLERRM);      
        ROLLBACK;
     END;      
            
   COMMIT;
   
   CLOSE C_CANCELAAF;    
   ---------------------------------
END;
